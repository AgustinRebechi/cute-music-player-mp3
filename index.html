<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Con mucho amor para Agos</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div class="window-controls">
        <button class="window-btn minimizeBtn" onclick="minimizeWindow()"></button>
        <button class="window-btn closeBtn" onclick="closeWindow()"></button>
    </div>

    <div class="main-window">
        
        <img src="assets/Cinna/ui/caja1.png" id="bg-img">
        <img src="assets/Cinna/cinna1.png" class="pj">
        <div class="marco"></div>
        
        <div class="marco">
        <img src="assets/marco.png" class="marco-img">
        </div>

        <div class="purin"><img src="assets/purin.gif" class="purin-img"></div>
        <div class="hk"><img src="assets/purin2.png" class="hk-img"></div>
                
        <div class="title-song">
            <img src="assets/Cinna/ui/caja4.png" id="bg-title">
            <h2 id="title"></h2>
        </div>

        <div class="cover">
            <div class="cover-bg" id="cover-bg"></div>
            <div class="lyrics-container">
                <div class="lyrics-line" id="lyricsLine1"></div>
                <div class="lyrics-line" id="lyricsLine2"></div>
                <div class="lyrics-line" id="lyricsLine3"></div>
            </div>
        </div>

        <div class="progress-bar" id="progressContainer">
            <div class="progress" id="progress"></div>
            <div class="music-duration">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-decorations">
                <div class="barra-decoration1"></div>
                <div class="barra-decoration2"></div>
                <div class="corazones-decoration1">
                    <div class="heart-individual heart1"></div>
                    <div class="heart-individual heart2"></div>
                    <div class="heart-individual heart3"></div>
                </div>
                
                <div class="corazones-decoration2">
                    <div class="heart-individual  heart1"></div>
                    <div class="heart-individual heart2"></div>
                    <div class="heart-individual heart3"></div>
                </div>
            </div>
            <button id="prev" class="prev-btn"></button>            
            <button id="playPause" class="play-btn"></button>
            <button id="next" class="next-btn"></button>

            <div class="additional-controls">
                <div class="volume-control">
                    <div class="volume-icon"></div>
                    <div class="volume-bar" id="volumeContainer">
                    <div class="volume-progress" id="volumeProgress"></div>
                </div>
                <button id="shuffleBtn" class="shuffle-btn"></button>
            </div>
        </div>        
    </div>

    <!-- Audio element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');
        
        let isPlaying = false;
        let isDragging = false;
        let isVolumeDragging = false;
        let currentSongIndex = 0;
        let playlist = [];
        let originalPlaylist = []; // Para el shuffle
        let currentLyrics = [];
        let lyricsInterval;
        let wasPlayingBeforeSkip = false;
        let isShuffleMode = false;
        let currentVolume = 0.7; // Volumen por defecto 70%
        
        const playButton = document.getElementById('playPause');
        const audioPlayer = document.getElementById('audioPlayer');
        const progressBar = document.getElementById('progress');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const titleDisplay = document.getElementById('title');
        const lyricsLine1 = document.getElementById('lyricsLine1');
        const lyricsLine2 = document.getElementById('lyricsLine2');
        const lyricsLine3 = document.getElementById('lyricsLine3');

        const volumeIcon = document.getElementById('volumeIcon');
        
        // Nuevos elementos
        const volumeContainer = document.getElementById('volumeContainer');
        const volumeProgress = document.getElementById('volumeProgress');
        const shuffleBtn = document.getElementById('shuffleBtn');
    

        const CUSTOM_ORDER = [
            'Fade Into You - Mazzy Star.mp3',
            'Dream a Little Dream of Me - Ella Fitzgerald.mp3',
            'La Vie En Rose - Édith Piaf.mp3',
            'Moon River - Audrey Hepburn.mp3',
            'Fly Me to the Moon - Frank Sinatra.mp3'
            // Agrega aquí tus canciones en el orden que prefieras
        ];

        // Función para actualizar la UI del botón play/pause
        function updatePlayButtonUI(playing) {
            if (playing) {
                playButton.className = 'pause-btn';
                isPlaying = true;
            } else {
                playButton.className = 'play-btn';
                isPlaying = false;
            }
        }

        // Mezclar array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Cargar playlist al inicio
        function loadPlaylist() {
            try {
                const songsDir = path.join(__dirname, 'songs');
                const files = fs.readdirSync(songsDir);
                
                const availableSongs = files
                    .filter(file => file.endsWith('.mp3'))
                    .map(file => ({
                        filename: file,
                        path: path.join(songsDir, file),
                        title: file.replace('.mp3', ''),
                        lyricsFile: path.join(songsDir, file.replace('.mp3', '.lrc'))
                    }));

                // Ordenar según el orden personalizado
                originalPlaylist = [];
                
                // Primero agregar las canciones en el orden personalizado
                CUSTOM_ORDER.forEach(customSong => {
                    const found = availableSongs.find(song => song.filename === customSong);
                    if (found) {
                        originalPlaylist.push(found);
                    }
                });
                
                // Luego agregar las canciones que no están en el orden personalizado
                availableSongs.forEach(song => {
                    if (!CUSTOM_ORDER.includes(song.filename)) {
                        originalPlaylist.push(song);
                    }
                });
                
                playlist = [...originalPlaylist];
                
                if (playlist.length > 0) {
                    loadSong(0);
                    // Configurar volumen inicial
                    audioPlayer.volume = currentVolume;
                    updateVolumeUI();
                } else {
                    titleDisplay.textContent = 'No se encontraron canciones';
                }
            } catch (error) {
                console.error('Error cargando playlist:', error);
                titleDisplay.textContent = 'Error cargando canciones';
            }
        }

        // Cargar una canción específica
        function loadSong(index, autoplay = false) {
            if (index >= 0 && index < playlist.length) {
                currentSongIndex = index;
                const song = playlist[index];
                
                audioPlayer.src = song.path;
                titleDisplay.textContent = song.title;
                
                // Cargar lyrics si existen
                loadLyrics(song.lyricsFile);
                
                // Reset UI
                progressBar.style.width = '0%';
                currentTimeDisplay.textContent = '0:00';
                durationDisplay.textContent = '0:00';
                clearLyrics();

                // Si debe reproducirse automáticamente
                if (autoplay) {
                    audioPlayer.addEventListener('loadeddata', function playWhenReady() {
                        audioPlayer.play().then(() => {
                            updatePlayButtonUI(true);
                        }).catch(error => {
                            console.error('Error al reproducir automáticamente:', error);
                            updatePlayButtonUI(false);
                        });
                        audioPlayer.removeEventListener('loadeddata', playWhenReady);
                    });
                } else {
                    updatePlayButtonUI(false);
                }
            }
        }

        // Cargar archivo LRC
        function loadLyrics(lyricsPath) {
            try {
                if (fs.existsSync(lyricsPath)) {
                    const lyricsContent = fs.readFileSync(lyricsPath, 'utf8');
                    currentLyrics = parseLRC(lyricsContent);
                } else {
                    currentLyrics = [];
                    console.log('No se encontró archivo de lyrics:', lyricsPath);
                }
            } catch (error) {
                console.error('Error cargando lyrics:', error);
                currentLyrics = [];
            }
        }

        // Parser para formato LRC
        function parseLRC(lrcContent) {
            const lyrics = [];
            const lines = lrcContent.split('\n');
            
            for (const line of lines) {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const centiseconds = parseInt(match[3]);
                    const text = match[4].trim();
                    
                    const timeInSeconds = minutes * 60 + seconds + (centiseconds / 100);
                    lyrics.push({ time: timeInSeconds, text: text });
                }
            }
            
            return lyrics.sort((a, b) => a.time - b.time);
        }

        // Limpiar lyrics
        function clearLyrics() {
            lyricsLine1.textContent = '';
            lyricsLine2.textContent = '';
            lyricsLine3.textContent = '';
            lyricsLine1.className = 'lyrics-line';
            lyricsLine2.className = 'lyrics-line';
            lyricsLine3.className = 'lyrics-line';
        }

        // Actualizar lyrics en tiempo real
        function updateLyrics() {
            if (currentLyrics.length === 0) return;
            
            const currentTime = audioPlayer.currentTime;
            let currentLyricIndex = -1;
            
            // Encontrar la línea actual
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    currentLyricIndex = i;
                } else {
                    break;
                }
            }
            
            // Mostrar líneas: anterior, actual, siguiente
            if (currentLyricIndex >= 0) {
                const prevLine = currentLyricIndex > 0 ? currentLyrics[currentLyricIndex - 1] : null;
                const currentLine = currentLyrics[currentLyricIndex];
                const nextLine = currentLyricIndex < currentLyrics.length - 1 ? currentLyrics[currentLyricIndex + 1] : null;
                
                lyricsLine1.textContent = prevLine ? prevLine.text : '';
                lyricsLine2.textContent = currentLine ? currentLine.text : '';
                lyricsLine3.textContent = nextLine ? nextLine.text : '';
                
                // Animar línea actual
                lyricsLine1.className = 'lyrics-line';
                lyricsLine2.className = 'lyrics-line active';
                lyricsLine3.className = 'lyrics-line';
            }
        }

        // Actualizar UI del volumen
        function updateVolumeUI() {
            const volumePercent = currentVolume * 100;
            volumeProgress.style.width = volumePercent + '%';
        }

        // Control de volumen
        
        function updateVolume(e) {
            const rect = volumeContainer.
            getBoundingClientRect();
            const volumeProgress = document.getElementById("volumeProgress");

            const clickX = e.clientX - rect.left;
            let newVolume = (clickX / rect.width);
            
            newVolume = Math.max(0, Math.min(1, newVolume));
            currentVolume = newVolume;
            audioPlayer.volume = currentVolume;

            const newProgressPercent = newVolume*100
            volumeProgress.style.width = newProgressPercent + '%';
        }

        // Toggle shuffle
        function toggleShuffle() {
            isShuffleMode = !isShuffleMode;
            
            if (isShuffleMode) {
                shuffleBtn.classList.add('active');
                playlist = shuffleArray(originalPlaylist);
                // Encontrar la canción actual en la nueva playlist mezclada
                const currentSong = originalPlaylist[currentSongIndex];
                currentSongIndex = playlist.findIndex(song => song.filename === currentSong.filename);
            } else {
                shuffleBtn.classList.remove('active');
                // Encontrar la canción actual en la playlist original
                const currentSong = playlist[currentSongIndex];
                playlist = [...originalPlaylist];
                currentSongIndex = originalPlaylist.findIndex(song => song.filename === currentSong.filename);
            }
        }

        // Event Listeners

        // Cargar metadata del audio
        audioPlayer.addEventListener('loadedmetadata', function() {
            if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
                const minutes = Math.floor(audioPlayer.duration / 60);
                const seconds = Math.floor(audioPlayer.duration % 60);
                durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        // Actualizar progreso mientras se reproduce
        audioPlayer.addEventListener('timeupdate', function() {
            if (!isDragging && audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + '%';
                
                const minutes = Math.floor(audioPlayer.currentTime / 60);
                const seconds = Math.floor(audioPlayer.currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Actualizar lyrics
                updateLyrics();
            }
        });

        // Funcionalidad de play/pause
        playButton.addEventListener('click', function() {
            if (isPlaying) {
                audioPlayer.pause();
                updatePlayButtonUI(false);
            } else {
                audioPlayer.play().then(() => {
                    updatePlayButtonUI(true);
                }).catch(error => {
                    console.error('Error al reproducir:', error);
                    alert('Error al cargar la canción');
                });
            }
        });

        // Cuando termine la canción, ir a la siguiente Y reproducir automáticamente
        audioPlayer.addEventListener('ended', function() {
            wasPlayingBeforeSkip = true;
            nextSong();
        });

        // Control de volumen - Click y drag
        volumeContainer.addEventListener('mousedown', function(e) {
            isVolumeDragging = true;
            updateVolume(e);
        });

        // Barra de progreso - Click en la barra de progreso
        progressContainer.addEventListener('mousedown', function(e) {
            if (audioPlayer.duration) {
                isDragging = true;
                updateProgress(e);
            }
        });

        // Arrastrar el corazón y el volumen
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                updateProgress(e);
            }
            if (isVolumeDragging) {
                updateVolume(e);
            }
        });

        // Soltar el corazón y el volumen
        document.addEventListener('mouseup', function() {
            isDragging = false;
            isVolumeDragging = false;
        });

        // Botón shuffle
        shuffleBtn.addEventListener('click', toggleShuffle);

        // Función para actualizar el progreso al arrastrar
        function updateProgress(e) {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            let newProgress = (clickX / rect.width) * 100;
            
            newProgress = Math.max(0, Math.min(100, newProgress));
            progressBar.style.width = newProgress + '%';
            
            if (audioPlayer.duration) {
                audioPlayer.currentTime = (newProgress / 100) * audioPlayer.duration;
                
                const minutes = Math.floor(audioPlayer.currentTime / 60);
                const seconds = Math.floor(audioPlayer.currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Canción anterior
        function previousSong() {
            wasPlayingBeforeSkip = isPlaying;
            const newIndex = currentSongIndex > 0 ? currentSongIndex - 1 : playlist.length - 1;
            loadSong(newIndex, wasPlayingBeforeSkip);
        }

        // Siguiente canción
        function nextSong() {
            wasPlayingBeforeSkip = wasPlayingBeforeSkip || isPlaying;
            const newIndex = currentSongIndex < playlist.length - 1 ? currentSongIndex + 1 : 0;
            loadSong(newIndex, wasPlayingBeforeSkip);
        }

        // Botones de navegación
        document.getElementById('prev').addEventListener('click', previousSong);
        document.getElementById('next').addEventListener('click', nextSong);

        // Funciones de ventana
        function minimizeWindow() {
            ipcRenderer.send('minimize-window');
        }

        function closeWindow() {
            ipcRenderer.send('close-window');
        }

        // Error handling para el audio
        audioPlayer.addEventListener('error', function(e) {
            console.error('Error de audio:', e);
            wasPlayingBeforeSkip = isPlaying;
            nextSong();
        });

        // Event listeners adicionales para controlar el estado del botón
        audioPlayer.addEventListener('play', function() {
            updatePlayButtonUI(true);
        });

        audioPlayer.addEventListener('pause', function() {
            updatePlayButtonUI(false);
        });

        // Inicializar al cargar la página
        window.addEventListener('DOMContentLoaded', function() {
            loadPlaylist();
        });

    </script>
</body>
</html>