<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Con mucho amor para Agos</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <div id="startScreen"       class="start-screen">
        <div class="cinna-intro">
            <img src="assets/Cinna/cinnamoroll.gif" id="cinnaIntro" class="cinna-intro-img">
            <div class="speech-bubble">
                <div id="introText" class="intro-text"></div>
            </div>
        </div>
        <div class="click-indicator">clicksito para seguir sisisi</div>
    </div>

    

    <div class="main-window">
        <div class="window-controls">
            <button class="window-btn minimizeBtn" onclick="minimizeWindow()"></button>
            <button class="window-btn closeBtn" onclick="closeWindow()"></button>
        </div>
        
        <img src="assets/Cinna/ui/caja1.png" id="bg-img">
        <img src="assets/Cinna/cinna1.png" class="pj">
        <div id="cinnaSpeech" class="cinna-speech-bubble" style="display: none;">
            <div id="cinnaText" class="cinna-speech-text"></div>
            <div class="cinna-bubble-arrow"></div>
        </div>

        <div class="marco"></div>
        
        <div class="marco">
        <img src="assets/marco.png" class="marco-img">
        </div>

        <div class="purin"><img src="assets/purin.gif" class="purin-img"></div>
        <div class="hk"><img src="assets/purin2.png" class="hk-img"></div>
                
        <div class="title-song">
            <img src="assets/Cinna/ui/caja4.png" id="bg-title">
            <h2 id="title"></h2>
        </div>

        <div class="cover">
            <div class="cover-bg" id="cover-bg"></div>
            <div class="lyrics-container">
                <div class="lyrics-line" id="lyricsLine1"></div>
                <div class="lyrics-line" id="lyricsLine2"></div>
                <div class="lyrics-line" id="lyricsLine3"></div>
            </div>
        </div>

        <div class="progress-bar" id="progressContainer">
            <div class="progress" id="progress"></div>
            <div class="music-duration">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-decorations">
                <div class="barra-decoration1"></div>
                <div class="barra-decoration2"></div>
                <div class="corazones-decoration1">
                    <div class="heart-individual heart1"></div>
                    <div class="heart-individual heart2"></div>
                    <div class="heart-individual heart3"></div>
                </div>
                
                <div class="corazones-decoration2">
                    <div class="heart-individual  heart1"></div>
                    <div class="heart-individual heart2"></div>
                    <div class="heart-individual heart3"></div>
                </div>
            </div>
            <button id="prev" class="prev-btn"></button>            
            <button id="playPause" class="play-btn"></button>
            <button id="next" class="next-btn"></button>

            <div class="additional-controls">
                <div class="volume-control">
                    <div class="volume-icon"></div>
                    <div class="volume-bar" id="volumeContainer">
                    <div class="volume-progress" id="volumeProgress"></div>
                </div>
                <button id="shuffleBtn" class="shuffle-btn"></button>
            </div>
        </div>        
    </div>

    <!-- Audio element -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');
        
        let isPlaying = false;
        let isDragging = false;
        let isVolumeDragging = false;
        let currentSongIndex = 0;
        let playlist = [];
        let originalPlaylist = []; // Para el shuffle
        let currentLyrics = [];
        let lyricsInterval;
        let wasPlayingBeforeSkip = false;
        let isShuffleMode = false;
        let currentVolume = 0.7; 
        let lastCommentTime = -1;
        
        const playButton = document.getElementById('playPause');
        const audioPlayer = document.getElementById('audioPlayer');
        const progressBar = document.getElementById('progress');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const titleDisplay = document.getElementById('title');
        const lyricsLine1 = document.getElementById('lyricsLine1');
        const lyricsLine2 = document.getElementById('lyricsLine2');
        const lyricsLine3 = document.getElementById('lyricsLine3');
        const volumeIcon = document.getElementById('volumeIcon');
        const volumeContainer = document.getElementById('volumeContainer');
        const volumeProgress = document.getElementById('volumeProgress');
        const shuffleBtn = document.getElementById('shuffleBtn');
        const startScreen = document.getElementById('startScreen');
        const introTextEl = document.getElementById('introText');

        const introMessages = [
        "Hola mibida ¿Cómo estás?",
        "Espero estes teniendo un bonito dia",
        "Si no es el caso, no te preocupes.  Siempre voy a estar junto a vos, no importa lo que pase",
        "cada vez que estas mal se me derrumba el mundo :(",
        "Te amo mucho, Agos <3",
        ];

        let currentMessageIndex = 0;
        let isTyping = false;

        const CUSTOM_ORDER = [
            'Favourite - Fontaines D.C.mp3',
            'Fade Into You - Mazzy Star.mp3',
            'All I Wanted - Paramore.mp3',
            'James Dean & Audrey Hepburn - SWS.mp3',
            'Love Takes Miles - Cameron Winter.mp3',
            'For Lovers - Lamp.mp3',
            'Love Songs On The Radio - Mojave 3.mp3',
            'Here, There and Everywhere - Emmylou Harris.mp3',
            

            'Till There Was You - The Beatles.mp3',
            'Thirteen - Big Star.mp3',

            'Milk - Sweet Trip.mp3',
            '슈게이저 - Misty Blue.mp3',
            '妖精の手招き - Ichiko Aoba.mp3',
            "j's lullaby - Delaney Bailey.mp3",
            'A Waltz For a Night - Julie Delpy.mp3',
            'The Fairest of the Seasons - Nico.mp3',

            'Save Me a Place - Fleetwood Mac.mp3',
            'In My Life - The Beatles.mp3',
            'Deirdre - Beach Boys.mp3',

            'My One And Only Love - John Coltrane.mp3',
            "I'm Glad There Is You - Julie London.mp3",

            'Picture Me Better - Weyes Blood.mp3',
            'Sidelines - Phoebe Bridgers.mp3',
            
            "First Day of My Life - Bright Eyes.mp3",
            'You Belong to Me - Jason Wade.mp3',
            "Nous sommes la réalité - socunbohemio.mp3",
            'Zombie Girl - Adrianne Lenker.mp3',
            
            'Well I Wonder - The Smiths.mp3', 

            'Be My Angel - Mazzy Star.mp3',
            'Halah - Mazzy Star.mp3',
            
    
            'God Only Knows - The Beach Boys.mp3',
            'Songbird - Fleetwood Mac.mp3',
            'Kiss Me - Sixpence None the Richer.mp3',
            'Music When The Lights Go Out - The Libertines.mp3',

            'Reel Around the Fountain - The Smiths.mp3',
            'Everybody Here Wants You - Jeff Buckley.mp3',
            'Hair and Skin - Mazzy Star.mp3',

            'About You - The 1975.mp3',
            'By Starlight - Smashing Pumpkins.mp3',
            'Invisible - Sunlid.mp3',

            "I Won't Share You - The Smiths.mp3",

            'How Deep Is Your Love - Bee Gees.mp3',

            'Help me - Joni Mitchell.mp3',

            'Please, Please, Please, Let Me Get What I Want - The Smiths.mp3',

            'Treacherous - Taylor Swift.mp3',
            'Stay Stay Stay - Taylor Swift.mp3',
            'Hate To See Your Heart Break - Paramore.mp3',
            'Deshoras - Babasonicos.mp3',

            'Samurai - Djavan.mp3',
            'Blow Away - George Harrison.mp3',
            "This Time I'm In It For Love - Player.mp3",
            "Last Train At 25 O'clock - Lamp.mp3",
            'On Melancholy Hill - Gorillazmp3.mp3',
            'Turista - Homogenica.mp3',
            'Word on a Wing - David Bowie.mp3',
            'The Boy With The Thorn In His Side - The Smiths.mp3',
            'Dreams Tonite - Alvvays.mp3',
            "Baby I'm Yours - Arctic Monkeys.mp3",
            'Dreams - The Cranberries.mp3',
            'Orbitando - Encargados.mp3',
            'Heaven Or Las Vegas - Cocteau Twins.mp3',
            'Just Like Heaven - The Cure mp3.mp3',
            'I Want To Know What Love Is - Foreigner.mp3',
            
            'Night Changes - One Direction.mp3',

            'When the Sun Hits - Slowdive.mp3',
            '40 Days - Slowdive.mp3',
            'Nadar Sola - Nenagenix.mp3',
            'Between Sleep and Awake - Whirr.mp3',
            'Luna - Wisp.mp3',
            'Mumble - Whirr.mp3',
            "Souvenirs D'Un Autre Monde - Alcest.mp3",
            'don’t ask why - My Bloody Valentine.mp3',

            'A Whiter Shade Of Pale - Procol Harum.mp3',

            'Will You Love Me Tomorrow - Carole King.mp3',

            'Your Song - Elton John.mp3',
            "We're All Alone - Rita Coolidge.mp3",
            'Eyes On Me - Fayes Wong.mp3',

            'A Primera Vista - Pedro Aznar.mp3',
            'El Tiempo Es Veloz - David Lebón.mp3',

            'Arrival - Parannoul.mp3',
            'Please Stay - Birth Day.mp3',

            'Brite Boy - Alex G.mp3',
            'Independence Day - Ellioth Smith.mp3',
            'Dark Sweet Lady - George Harrison.mp3',

            'Words Of Love - Arthur Russell.mp3',

            'A Pillow Of Winds - Pink Floyd.mp3',
            'Wicked Game - Chris Isaac.mp3',

            "I Don't Care If You're Contagious - PTV.mp3",
        ];

        const songComments = {            
            'Favourite - Fontaines D.C': {
                1.0: "Oaaaaaa",
                7.0: "siempre fuiste, sos y seguiras siendo mi favorita mibida<3",
                13.0: "No sabes la cantidad de veces que escuche esta canción en abril nyehehe",
                18.0: "Te hice agarrar los anteojos para ver esta letrita?",
                24.0:"Era muy compliqueti hacerlo mas grande, perdon puch",
                30.0: "Cualquier cosa te deje esta playlist en mi spoti",
                36.0: "Y podes ver cuando añadi las canciones nyehehe",
                42.0: "Te hago spoiler: 14 de mayo",
                48.0: "Desde ahi ya tenia pensado regalarte esto, pero para nuestro primer mes",
                53.0: "con el botoncito que hay 2 flechas podes ponerlo aleatorio",
                59.0: "pero esta en este orden por defecto sisis",
                64.0: "no veas el codigo fuente de este porfi es un horror",
                70.0: "Los assts si queres si sisisi"
            },

            'Fade Into You - Mazzy Star': {
                1.0: "oaaaaa",
                10.0: "asdasdasdasd"
            },

            'Picture Me Better - Weyes Blood': {
                1.0: "oaaaaaa"
            },

            'Sidelines - Phoebe Bridgers': {
                1.0: "oaaaaaa"
            },


        };
        
        const coverImages = [
            'caja3-1.png',
            'caja3-2.png',
            'caja3-3.png',
            'caja3-4.png',
            'caja3-5.png',
            'caja3-6.png',
            'caja3-7.png',
            'caja3-8.png',
            'caja3-9.png',
            'caja3-10.png',
            'caja3-11.png',
            'caja3-12.png',
            'caja3-13.png',
            'caja3-14.png',
        ]

        // Función para actualizar la UI del botón play/pause
        function updatePlayButtonUI(playing) {
            if (playing) {
                playButton.className = 'pause-btn';
                isPlaying = true;
            } else {
                playButton.className = 'play-btn';
                isPlaying = false;
            }
        }

        // Mezclar array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Cargar playlist al inicio
        function loadPlaylist() {
            try {
                const songsDir = path.join(__dirname, 'songs');
                const files = fs.readdirSync(songsDir);
                
                const availableSongs = files
                    .filter(file => file.endsWith('.mp3'))
                    .map(file => ({
                        filename: file,
                        path: path.join(songsDir, file),
                        title: file.replace('.mp3', ''),
                        lyricsFile: path.join(songsDir, file.replace('.mp3', '.lrc'))
                    }));

                // Ordenar según el orden personalizado
                originalPlaylist = [];
                
                // Primero agregar las canciones en el orden personalizado
                CUSTOM_ORDER.forEach(customSong => {
                    const found = availableSongs.find(song => song.filename === customSong);
                    if (found) {
                        originalPlaylist.push(found);
                    }
                });
                
                // Luego agregar las canciones que no están en el orden personalizado
                availableSongs.forEach(song => {
                    if (!CUSTOM_ORDER.includes(song.filename)) {
                        originalPlaylist.push(song);
                    }
                });
                
                playlist = [...originalPlaylist];
                
                if (playlist.length > 0) {
                    loadSong(0);
                    // Configurar volumen inicial
                    audioPlayer.volume = currentVolume;
                    updateVolumeUI();
                } else {
                    titleDisplay.textContent = 'No se encontraron canciones';
                }
            } catch (error) {
                console.error('Error cargando playlist:', error);
                titleDisplay.textContent = 'Error cargando canciones';
            }
        }

        // Cargar una canción específica
        function loadSong(index, autoplay = false) {
            if (index >= 0 && index < playlist.length) {
                currentSongIndex = index;
                lastCommentTime = -1;
                const song = playlist[index];
                
                audioPlayer.src = song.path;
                titleDisplay.textContent = song.title;

                const coverIndex = currentSongIndex % coverImages.length;
                const newCoverPath = `./assets/Cinna/ui/${coverImages[coverIndex]}`;
                changeCoverWithAnimation(newCoverPath);
                
                // Cargar lyrics si existen
                loadLyrics(song.lyricsFile);
                
                // Reset UI
                progressBar.style.width = '0%';
                currentTimeDisplay.textContent = '0:00';
                durationDisplay.textContent = '0:00';
                clearLyrics();

                // Si debe reproducirse automáticamente
                if (autoplay) {
                    audioPlayer.addEventListener('loadeddata', function playWhenReady() {
                        audioPlayer.play().then(() => {
                            updatePlayButtonUI(true);
                        }).catch(error => {
                            console.error('Error al reproducir automáticamente:', error);
                            updatePlayButtonUI(false);
                        });
                        audioPlayer.removeEventListener('loadeddata', playWhenReady);
                    });
                } else {
                    updatePlayButtonUI(false);
                }
            }
        }

        // Cargar archivo LRC
        function loadLyrics(lyricsPath) {
            try {
                if (fs.existsSync(lyricsPath)) {
                    const lyricsContent = fs.readFileSync(lyricsPath, 'utf8');
                    currentLyrics = parseLRC(lyricsContent);
                } else {
                    currentLyrics = [];
                    console.log('No se encontró archivo de lyrics:', lyricsPath);
                }
            } catch (error) {
                console.error('Error cargando lyrics:', error);
                currentLyrics = [];
            }
        }

        // Parser para formato LRC
        function parseLRC(lrcContent) {
            const lyrics = [];
            const lines = lrcContent.split('\n');
            
            for (const line of lines) {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const centiseconds = parseInt(match[3]);
                    const text = match[4].trim();
                    
                    const timeInSeconds = minutes * 60 + seconds + (centiseconds / 100);
                    lyrics.push({ time: timeInSeconds, text: text });
                }
            }
            
            return lyrics.sort((a, b) => a.time - b.time);
        }

        // Limpiar lyrics
        function clearLyrics() {
            lyricsLine1.textContent = '';
            lyricsLine2.textContent = '';
            lyricsLine3.textContent = '';
            lyricsLine1.className = 'lyrics-line';
            lyricsLine2.className = 'lyrics-line';
            lyricsLine3.className = 'lyrics-line';
        }

        function changeCoverWithAnimation(newImagePath) {
            const cover = document.querySelector('.cover');
            
            // Animación de salida
            cover.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            cover.style.opacity = '0';
            cover.style.transform = 'translateX(-50%) scale(0.9)';
            
            setTimeout(() => {
                // Cambiar la imagen
                cover.style.backgroundImage = `url("${newImagePath}")`;
                
                // Animación de entrada
                cover.style.opacity = '1';
                cover.style.transform = 'translateX(-50%) scale(1)';
            }, 250);
        }

        // Actualizar lyrics en tiempo real
        function updateLyrics() {
            const currentTime = audioPlayer.currentTime;
            
            // COMENTARIOS DE CINNA - MOVER AQUÍ ARRIBA, antes del check de lyrics
            checkForCinnaComments(currentTime, '');
            
            // Ahora sí verificar si hay lyrics para mostrar
            if (currentLyrics.length === 0) return;
            
            let currentLyricIndex = -1;
            
            // Encontrar la línea actual
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentLyrics[i].time <= currentTime) {
                    currentLyricIndex = i;
                } else {
                    break;
                }
            }
            
            // Mostrar líneas: anterior, actual, siguiente
            if (currentLyricIndex >= 0) {
                const prevLine = currentLyricIndex > 0 ? currentLyrics[currentLyricIndex - 1] : null;
                const currentLine = currentLyrics[currentLyricIndex];
                const nextLine = currentLyricIndex < currentLyrics.length - 1 ? currentLyrics[currentLyricIndex + 1] : null;
                
                lyricsLine1.textContent = prevLine ? prevLine.text : '';
                lyricsLine2.textContent = currentLine ? currentLine.text : '';
                lyricsLine3.textContent = nextLine ? nextLine.text : '';
                
                // Animar línea actual
                lyricsLine1.className = 'lyrics-line';
                lyricsLine2.className = 'lyrics-line active';
                lyricsLine3.className = 'lyrics-line';
                
                // Si hay lyrics, también pasar el texto actual a los comentarios
                // (pero ya se ejecutó arriba de todas formas)
            }
        }

        // Actualizar UI del volumen
        function updateVolumeUI() {
            const volumePercent = currentVolume * 100;
            volumeProgress.style.width = volumePercent + '%';
        }

        // Control de volumen
        
        function updateVolume(e) {
            const rect = volumeContainer.
            getBoundingClientRect();
            const volumeProgress = document.getElementById("volumeProgress");

            const clickX = e.clientX - rect.left;
            let newVolume = (clickX / rect.width);
            
            newVolume = Math.max(0, Math.min(1, newVolume));
            currentVolume = newVolume;
            audioPlayer.volume = currentVolume;

            const newProgressPercent = newVolume*100
            volumeProgress.style.width = newProgressPercent + '%';
        }

        // Toggle shuffle
        function toggleShuffle() {
            isShuffleMode = !isShuffleMode;
            
            if (isShuffleMode) {
                shuffleBtn.classList.add('active');
                playlist = shuffleArray(originalPlaylist);
                // Encontrar la canción actual en la nueva playlist mezclada
                const currentSong = originalPlaylist[currentSongIndex];
                currentSongIndex = playlist.findIndex(song => song.filename === currentSong.filename);
            } else {
                shuffleBtn.classList.remove('active');
                // Encontrar la canción actual en la playlist original
                const currentSong = playlist[currentSongIndex];
                playlist = [...originalPlaylist];
                currentSongIndex = originalPlaylist.findIndex(song => song.filename === currentSong.filename);
            }
        }

        // Event Listeners

        // Cargar metadata del audio
        audioPlayer.addEventListener('loadedmetadata', function() {
            if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
                const minutes = Math.floor(audioPlayer.duration / 60);
                const seconds = Math.floor(audioPlayer.duration % 60);
                durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        // Actualizar progreso mientras se reproduce
        audioPlayer.addEventListener('timeupdate', function() {
            if (!isDragging && audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.width = progress + '%';
                
                const minutes = Math.floor(audioPlayer.currentTime / 60);
                const seconds = Math.floor(audioPlayer.currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                // Actualizar lyrics
                updateLyrics();
            }
        });

        // Funcionalidad de play/pause
        playButton.addEventListener('click', function() {
            if (isPlaying) {
                audioPlayer.pause();
                updatePlayButtonUI(false);
            } else {
                audioPlayer.play().then(() => {
                    updatePlayButtonUI(true);
                }).catch(error => {
                    console.error('Error al reproducir:', error);
                    alert('Error al cargar la canción');
                });
            }
        });

        // Cuando termine la canción, ir a la siguiente Y reproducir automáticamente
        audioPlayer.addEventListener('ended', function() {
            wasPlayingBeforeSkip = true;
            nextSong();
        });

        // Control de volumen - Click y drag
        volumeContainer.addEventListener('mousedown', function(e) {
            isVolumeDragging = true;
            updateVolume(e);
        });

        // Barra de progreso - Click en la barra de progreso
        progressContainer.addEventListener('mousedown', function(e) {
            if (audioPlayer.duration) {
                isDragging = true;
                updateProgress(e);
            }
        });

        // Arrastrar el corazón y el volumen
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                updateProgress(e);
            }
            if (isVolumeDragging) {
                updateVolume(e);
            }
        });

        // Soltar el corazón y el volumen
        document.addEventListener('mouseup', function() {
            isDragging = false;
            isVolumeDragging = false;
        });

        // Botón shuffle
        shuffleBtn.addEventListener('click', toggleShuffle);

        // Función para actualizar el progreso al arrastrar
        function updateProgress(e) {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            let newProgress = (clickX / rect.width) * 100;
            
            newProgress = Math.max(0, Math.min(100, newProgress));
            progressBar.style.width = newProgress + '%';
            
            if (audioPlayer.duration) {
                audioPlayer.currentTime = (newProgress / 100) * audioPlayer.duration;
                
                const minutes = Math.floor(audioPlayer.currentTime / 60);
                const seconds = Math.floor(audioPlayer.currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Canción anterior
        function previousSong() {
            wasPlayingBeforeSkip = isPlaying;
            const newIndex = currentSongIndex > 0 ? currentSongIndex - 1 : playlist.length - 1;
            loadSong(newIndex, wasPlayingBeforeSkip);
        }

        // Siguiente canción
        function nextSong() {
            wasPlayingBeforeSkip = wasPlayingBeforeSkip || isPlaying;
            const newIndex = currentSongIndex < playlist.length - 1 ? currentSongIndex + 1 : 0;
            loadSong(newIndex, wasPlayingBeforeSkip);
        }

        // Botones de navegación
        document.getElementById('prev').addEventListener('click', previousSong);
        document.getElementById('next').addEventListener('click', nextSong);

        function minimizeWindow() {
            const mainWindow = document.querySelector('.main-window');
            const minimizeBtn = document.querySelector('.minimizeBtn');
            
            // Animar el botón
            minimizeBtn.style.animation = 'minimizeAnim 0.5s ease-out';
            
            // Animar la ventana
            mainWindow.classList.add('minimizing');
            
            setTimeout(() => {
                ipcRenderer.send('minimize-window');
                mainWindow.classList.remove('minimizing');
                minimizeBtn.style.animation = ''; // Reset animation
            }, 500);
        }

        function closeWindow() {
            const mainWindow = document.querySelector('.main-window');
            const closeBtn = document.querySelector('.closeBtn');
            
            // Animar el botón
            closeBtn.style.animation = 'closeAnim 0.5s ease-out';
            
            // Animar la ventana
            mainWindow.classList.add('closing');
            
            setTimeout(() => {
                ipcRenderer.send('close-window');
            }, 500);
        }        

        // Error handling para el audio
        audioPlayer.addEventListener('error', function(e) {
            console.error('Error de audio:', e);
            wasPlayingBeforeSkip = isPlaying;
            nextSong();
        });

        // Event listeners adicionales para controlar el estado del botón
        audioPlayer.addEventListener('play', function() {
            updatePlayButtonUI(true);
        });

        audioPlayer.addEventListener('pause', function() {
            updatePlayButtonUI(false);
        });

        window.addEventListener('DOMContentLoaded', () => {
            // Iniciar el primer mensaje automáticamente
            typeText(introMessages[0], introTextEl);
            currentMessageIndex = 1;
    
            // Configurar el handler para los   siguientes clicks
            startScreen.addEventListener('click', handleIntroClick);
        });

        // Primer click: desbloquea audio y arranca el primer mensaje
        function startFirstMessage() {
            const introText = document.getElementById('introText');
            typeText(introMessages[0], introText);
            currentMessageIndex = 1;

            // Ahora configuramos el handler para los siguientes clicks
            startScreen.addEventListener('click', handleIntroClick);
        }

        function unlockAudio() {
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => {});
            }
        }

        function typeText(text, element, callback) {
            if (isTyping) return;
            isTyping = true;
            element.textContent = '';
            let index = 0;

            const typeInterval = setInterval(() => {
                if (index < text.length) {
                    element.textContent += text[index];
                    index++;
                } else {
                    clearInterval(typeInterval);
                    isTyping = false;
                    if (callback) callback();
                }
            }, 50);
        }

        // Manejar clicks en pantalla de inicio
        function handleIntroClick() {
            if (isTyping) return;
            
            if (currentMessageIndex < introMessages.length) {
                // Si todavía hay mensajes, muestra el siguiente
                typeText(introMessages[currentMessageIndex], introTextEl);
                currentMessageIndex++;
            } else {
                // Terminar introducción
                startMainApp();
            }
        }

        function startMainApp() {
            const startScreen = document.getElementById('startScreen');
            const mainWindow = document.querySelector('.main-window');
            
            startScreen.style.animation = 'fadeOut 1s ease-out forwards';
            
            setTimeout(() => {
                startScreen.style.display = 'none';
                mainWindow.style.display = 'block';
                mainWindow.style.animation = 'mainWindowAppear 1.5s';
                loadPlaylist();
            }, 1000);
        }

        // CSS para fadeOut
        const fadeOutCSS = `
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }
        `;        

        // Función para que Cinna comente durante las canciones
        function showCinnaSpeech(text, duration = 5000) {
            const cinnaSpeeech = document.getElementById('cinnaSpeech');
            const cinnaText = document.getElementById('cinnaText');
            
            const formattedText = formatTextForBubble(text, 25);
            
            cinnaText.textContent = formattedText;
            cinnaSpeeech.style.display = 'block';
            cinnaSpeeech.style.display = 'block';
            
            // Ocultar después del tiempo especificado
            setTimeout(() => {
                cinnaSpeeech.style.display = 'none';
            }, duration);
        }
        // Función para formatear texto con saltos de línea
        function formatTextForBubble(text, maxLength) {
            if (text.length <= maxLength) return text;
            
            const words = text.split(' ');
            let lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + word).length <= maxLength) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines.join('\n');
        }
            
        function checkForCinnaComments(currentTime, currentLyric) {
            const currentSong = playlist[currentSongIndex]?.title;
            
            if (!currentSong) return;
            
            // Buscar comentarios usando diferentes formatos del nombre
            let songData = songComments[currentSong];
            
            // Si no encuentra, intentar con el nombre original del archivo
            if (!songData && playlist[currentSongIndex]) {
                const originalFilename = playlist[currentSongIndex].filename;
                const titleFromFilename = originalFilename.replace('.mp3', '');
                songData = songComments[titleFromFilename];
            }
            
            if (!songData) return;
            
            Object.keys(songData).forEach(time => {
                const targetTime = parseFloat(time);
                if (Math.abs(currentTime - targetTime) < 0.2 && lastCommentTime !== targetTime) {
                    showCinnaSpeech(songData[time]);
                    lastCommentTime = targetTime;
                }
            });
        }

        // ===== Web Audio API para sonido de tipeo =====
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let typeBuffer = null;
        let typeSoundEnabled = true;
        // Crear un nodo de ganancia global
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.1; // volumen 15% (ajustá a gusto)
        gainNode.connect(audioCtx.destination);

        // Cargar el archivo de sonido una sola vez
        function loadTypeSound() {
            const typePath = path.join(__dirname, 'assets', 'sounds', 'type.mp3');
            try {
                const data = fs.readFileSync(typePath);
                const arrayBuffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);
                audioCtx.decodeAudioData(arrayBuffer).then(decoded => {
                    typeBuffer = decoded;
                }).catch(err => console.error('decodeAudioData error', err));
            } catch (err) {
                console.error('No se pudo leer type.mp3', err);
            }
        }

        // Reproducir el "tic" de tipeo
        function playTypeSound() {
            if (!typeBuffer || !typeSoundEnabled) return;
            const src = audioCtx.createBufferSource();
            src.buffer = typeBuffer;
            src.connect(gainNode); 
            src.start(0);
            src.start(0);
            src.stop(audioCtx.currentTime + 0.05);

        }

        // Desactivar sonidos de tipeo (ej: al pasar a la ventana principal)
        function stopTypeSounds() {
            typeSoundEnabled = false;
        }


    </script>
</body>
</html>